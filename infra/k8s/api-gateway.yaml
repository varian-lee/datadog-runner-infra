# ğŸšª KrakenD API Gateway - Kubernetes ë°°í¬ ì„¤ì •
# ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í†µí•© API Gateway
# - ëª¨ë“  ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ë¼ìš°íŒ… (/api/auth, /api/chat, /api/ranking, /rankings)
# - OpenTelemetry Prometheus ë©”íŠ¸ë¦­ (í¬íŠ¸ 9090)
# - Datadog Autodiscovery ì„¤ì • (OpenMetrics ìˆ˜ì§‘)
# - ë¶„ì‚° íŠ¸ë ˆì´ì‹± ë° CORS ì§€ì›

apiVersion: apps/v1
kind: Deployment
metadata: 
  name: api-gateway
  labels:
    tags.datadoghq.com/env: demo
    tags.datadoghq.com/service: api-gateway
    tags.datadoghq.com/version: "0.1.0"
spec:
  replicas: 2
  selector: { matchLabels: { app: api-gateway } }
  template:
    metadata:
      labels: 
        app: api-gateway
        admission.datadoghq.com/enabled: "true"
      annotations:
        ad.datadoghq.com/api-gateway.checks: |
          {
            "krakend": {
              "init_config": {},
              "instances": [
                {
                  "openmetrics_endpoint": "http://%%host%%:9090/metrics",
                  "metrics": [".*"],
                  "process_metrics": true,
                  "go_metrics": true
                }
              ]
            }
          }
        admission.datadoghq.com/go-lib.version: latest
    spec:
      containers:
      - name: api-gateway
        image: 222066942551.dkr.ecr.ap-northeast-2.amazonaws.com/datadog-runner/api-gateway:latest
        ports:
        - containerPort: 8080
        - containerPort: 9090
        env:
        - {name: DD_LOGS_INJECTION, value: "true"}
        - {name: DD_APPSEC_ENABLED, value: "true"}
        - {name: DD_TRACE_ENABLED, value: "true"}
        readinessProbe: { httpGet: { path: "/health", port: 8080 }, initialDelaySeconds: 5 }
        livenessProbe: { httpGet: { path: "/health", port: 8080 }, initialDelaySeconds: 10 }
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
---
apiVersion: v1
kind: Service
metadata: { name: api-gateway-svc }
spec:
  selector: { app: api-gateway }
  ports: 
  - { port: 8080, targetPort: 8080, name: api }
  - { port: 9090, targetPort: 9090, name: metrics }
