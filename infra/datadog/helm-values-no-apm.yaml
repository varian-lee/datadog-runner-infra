# 📊 Datadog Agent Helm Values - Kubernetes 클러스터 통합 모니터링
# 
# 주요 기능:
# - APM: 분산 트레이싱 (모든 마이크로서비스)
# - 로그: 컨테이너 로그 수집 및 파싱
# - 메트릭: 시스템, 애플리케이션, 커스텀 메트릭
# - Autodiscovery: 자동 서비스 발견 및 설정
# - OpenMetrics: Prometheus 메트릭 수집 (KrakenD)
# 
# 설정 히스토리:
# - 처음 datadog.env: demo 로 설정했다가 Helm template 오류 발생하여 tags 방식으로 변경
datadog:
  site: datadoghq.com
  clusterName: datadog-runner-cluster 
  # 새로운 Datadog 계정으로 변경 시:
  # 방법 1: 직접 API key 설정
  # apiKey: "새로운_API_키"
  # 방법 2: 새로운 secret 참조  
  # apiKeyExistingSecret: datadog-secret
  apiKeyExistingSecret: datadog-secret-new
  # logLevel: debug               # DEBUG 로그 활성화 시 주석 해제 (환경변수 DD_LOG_LEVEL과 함께 사용)
  tags:
    - env:demo                    # 환경 태그 (서비스들과 일치)
    - testtag:testtag_value                    # 테스트 태그
    - cluster_name:datadog-runner-cluster  # 클러스터 태그 추가
  logs:
    enabled: true
    containerCollectAll: true     # 모든 컨테이너 로그 수집
  apm:
    enabled: false                 # Application Performance Monitoring
    portEnabled: false       # TCP 포트 8126 비활성화
    socketEnabled: false     # Unix socket 비활성화
  processAgent:
    enabled: false                 # 프로세스 모니터링
  networkMonitoring:
    enabled: false                 # 네트워크 모니터링
  dbm:
    enabled: false                 # Database Monitoring
  kubeStateMetricsEnabled: false   # K8s 상태 메트릭
  
  # Kubelet Integration 커스터마이제이션
  # kubernetes.kubelet.pod.start.duration.count 메트릭 수집을 위해 Python check 사용
  kubelet:
    coreCheckEnabled: false       # Go 코어 체크 비활성화, Python 체크 활성화
  
  # confd 사용 시 기존 설정을 완전히 대체하므로 필수 설정들을 모두 포함
  confd:
    kubelet.yaml: |-
      ad_identifiers:             # Autodiscovery 식별자 (필수)
        - _kubelet
      init_config: null           # 초기화 설정 (필수)
      instances:
        - min_collection_interval: 20           # 20초 간격으로 메트릭 수집
          send_distribution_buckets: true       # 히스토그램 버킷을 분포로 전송
          # 참고: send_distribution_buckets 활성화 시 일부 duration 메트릭이 사라지는 이슈 존재

# Agent 컨테이너 설정
agents:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: is-dd-apm
            operator: DoesNotExist    # is-dd-apm 라벨이 없는 노드 (APM 비활성화)

  containers:
    agent:
      env:
        # APM 완전 비활성화
        - name: DD_APM_ENABLED
          value: "false"
        # 로컬이 아닌 트래픽으로부터의 APM 트레이스 수신 차단
        - name: DD_APM_NON_LOCAL_TRAFFIC
          value: "false"
        # 로컬이 아닌 소스로부터의 DogStatsD 메트릭 수신 허용  
        - name: DD_DOGSTATSD_NON_LOCAL_TRAFFIC
          value: "false"
        
        # 🔄 Dual Shipping 설정 - APM 제외하고 메트릭 + 로그만
        # 📊 메트릭 Dual Shipping
        - name: DD_ADDITIONAL_ENDPOINTS
          valueFrom:
            secretKeyRef:
              name: datadog-dual-shipping-secret
              key: metrics
        
        # 📋 로그 Dual Shipping  
        - name: DD_LOGS_CONFIG_FORCE_USE_HTTP
          value: "true"
        - name: DD_LOGS_CONFIG_ADDITIONAL_ENDPOINTS
          valueFrom:
            secretKeyRef:
              name: datadog-dual-shipping-secret
              key: logs

# 기존 Cluster Agent 재사용
existingClusterAgent:
  join: true
  serviceName: "datadog-standard-cluster-agent"        # Standard 배포의 Cluster Agent 서비스
  tokenSecretName: "datadog-standard-cluster-agent"    # Standard 배포의 인증 토큰

# Cluster Agent 중복 방지
clusterAgent:
  enabled: false